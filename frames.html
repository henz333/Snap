<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Select Frame â€” abcSnap</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--blue1:#1E3C72;--blue2:#2A5298;--yellow:#FFD93D;--accent:#2A5298}
    body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--blue1),var(--blue2));color:#fff;display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:24px;box-sizing:border-box}
    h1{font-family:'Baloo 2',cursive;color:var(--yellow);margin:0 0 8px;font-size:2rem}
    p.lead{margin:0 0 18px;color:rgba(255,255,255,0.9)}
    .layout{display:flex;gap:24px;width:100%;max-width:1400px;align-items:flex-start;justify-content:center;flex-wrap:wrap}
    .frame-grid{width:480px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .frame{background:rgba(255,255,255,0.06);border-radius:12px;padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .15s,box-shadow .15s}
    .frame:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(0,0,0,0.35)}
    .frame img{width:100%;height:auto;border-radius:8px;object-fit:contain;display:block}
    #preview-container{width:540px;min-height:640px;background:rgba(255,255,255,0.06);border-radius:14px;padding:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(0,0,0,0.35)}
    #preview-title{color:rgba(255,255,255,0.9);margin-bottom:8px;font-weight:600}
    #preview-canvas{background:#111;border-radius:8px;max-width:100%;height:auto;display:block}
    .help{font-size:0.9rem;color:rgba(255,255,255,0.7);margin-top:10px}
    .controls{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
    button.primary{background:var(--yellow);color:var(--accent);border:none;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 10px 20px rgba(0,0,0,0.2)}
    button.ghost{background:transparent;color:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.08);padding:10px 14px;border-radius:10px;cursor:pointer}
    footer{margin-top:28px;color:rgba(255,255,255,0.7);font-size:0.9rem}
    @media (max-width:1000px){.layout{flex-direction:column;align-items:center}.frame-grid{width:90%;grid-template-columns:repeat(3,1fr)}#preview-container{width:90%}}
  </style>
</head>
<body>
  <h1>ðŸŽ¨ Choose Your Frame</h1>
  <p class="lead">Click a frame on the left â€” preview will show on the right. When it looks good, press <strong>Confirm Frame</strong>.</p>

  <div class="layout">
    <div class="frame-grid" id="frameGrid"></div>

    <div id="preview-container" aria-live="polite">
      <div id="preview-title">Preview</div>
      <canvas id="preview-canvas"></canvas>
      <div class="help">Preview updates immediately when you click a frame. Confirm to continue.</div>

      <div class="controls">
        <button id="confirmBtn" class="primary" disabled>Confirm Frame</button>
        <button id="backBtn" class="ghost">Back to Capture</button>
      </div>
    </div>
  </div>

  <footer>abcSnap Booth â€” Business Week 2025</footer>

  <script>
  (function(){
    // ---------- Use the exact sizes & slots you provided ----------
    // natural sizes of frames (frame image files must match these)
    const FRAME_SIZES = {
      1: {w:1748, h:1240},
      2: {w:1748, h:1240},
      3: {w:1748, h:1240},
      4: {w:1748, h:1240},
      5: {w:707,  h:2000},
      6: {w:707,  h:2000}
    };

    // exact slot coordinates you gave for frames 1..6 (use those numbers)
    const FRAME_SLOTS = {
      1: [
        {x:54,  y:508,  w:800, h:457},
        {x:890, y:508,  w:800, h:457},
        {x:54,  y:1000, w:800, h:457},
        {x:890, y:1000, w:800, h:457}
      ],
      2: [ // same as 1 per your list
        {x:54,  y:508,  w:800, h:457},
        {x:890, y:508,  w:800, h:457},
        {x:54,  y:1000, w:800, h:457},
        {x:890, y:1000, w:800, h:457}
      ],
      3: [
        {x:60,   y:668,  w:854, h:567},
        {x:60,   y:1136, w:516, h:412},
        {x:626,  y:1135, w:516, h:412},
        {x:1186, y:1135, w:516, h:412}
      ],
      4: [ // same as 3
        {x:60,   y:668,  w:854, h:567},
        {x:60,   y:1136, w:516, h:412},
        {x:626,  y:1135, w:516, h:412},
        {x:1186, y:1135, w:516, h:412}
      ],
      5: [
        {x:41, y:420,  w:623, h:378},
        {x:41, y:840,  w:623, h:378},
        {x:41, y:1265, w:623, h:378},
        {x:41, y:1689, w:623, h:378}
      ],
      6: [
        {x:41, y:420,  w:623, h:378},
        {x:41, y:840,  w:623, h:378},
        {x:41, y:1265, w:623, h:378},
        {x:41, y:1689, w:623, h:378}
      ]
    };

    // DOM
    const frameGrid = document.getElementById('frameGrid');
    const previewCanvas = document.getElementById('preview-canvas');
    const confirmBtn = document.getElementById('confirmBtn');
    const backBtn = document.getElementById('backBtn');

    // Load photos from sessionStorage (your snap page stores sessionStorage.photos)
    const photos = JSON.parse(sessionStorage.getItem('photos') || '[]');
    if (!photos || photos.length < 4) {
      alert('No photos found â€” please take your 4 photos first.');
      window.location.href = 'snap.html';
      return;
    }

    // Build thumbnails / frame list
    const FRAME_COUNT = 6;
    for (let i=1;i<=FRAME_COUNT;i++){
      const div = document.createElement('div');
      div.className = 'frame';
      div.innerHTML = `<img src="frames/frame${i}.png" alt="Frame ${i}" data-index="${i}">`;
      div.addEventListener('click', () => onFrameClick(i));
      frameGrid.appendChild(div);
    }

    // helper to load images (dataURLs or files)
    function loadImage(src){
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res(img);
        img.onerror = (e) => rej(e);
        img.src = src;
      });
    }

    // COVER draw: scale image to cover the target rect (no black areas)
    function drawImageCover(ctx, img, tx, ty, tw, th){
      const iw = img.naturalWidth;
      const ih = img.naturalHeight;
      // scale to cover
      const scale = Math.max(tw / iw, th / ih);
      const dw = Math.round(iw * scale);
      const dh = Math.round(ih * scale);
      // center crop within target
      const dx = Math.round(tx - (dw - tw) / 2);
      const dy = Math.round(ty - (dh - th) / 2);
      ctx.drawImage(img, dx, dy, dw, dh);
    }

    // Called when user clicks a frame thumbnail
    async function onFrameClick(frameIndex){
      confirmBtn.disabled = false;

      // load frame PNG
      const frameSrc = `frames/frame${frameIndex}.png`;
      const frameImg = await loadImage(frameSrc);

      // Use the frame image's natural pixel size to set canvas
      const canvasW = frameImg.naturalWidth || FRAME_SIZES[frameIndex].w;
      const canvasH = frameImg.naturalHeight || FRAME_SIZES[frameIndex].h;

      previewCanvas.width = canvasW;
      previewCanvas.height = canvasH;
      // scale CSS display so it fits preview container nicely
      const container = document.getElementById('preview-container');
      const displayW = Math.min(container.clientWidth - 32, 520);
      previewCanvas.style.width = displayW + 'px';
      previewCanvas.style.height = Math.round(displayW * (canvasH / canvasW)) + 'px';

      const ctx = previewCanvas.getContext('2d');
      ctx.clearRect(0,0,canvasW,canvasH);

      // draw each photo into its slot using cover fill
      const slots = FRAME_SLOTS[frameIndex];
      for (let i=0;i<4;i++){
        const s = slots[i];
        // defensive: if slot missing skip
        if (!s) continue;
        const photoSrc = photos[i];
        try {
          const img = await loadImage(photoSrc);
          drawImageCover(ctx, img, s.x, s.y, s.w, s.h);
        } catch(e){
          // if a photo failed to load, fill black area so it's obvious
          ctx.fillStyle = '#000';
          ctx.fillRect(s.x, s.y, s.w, s.h);
          console.error('photo load failed', e);
        }
      }

      // draw the frame PNG on top (so the holes remain transparent)
      ctx.drawImage(frameImg, 0, 0, canvasW, canvasH);

      // save current selection for confirm
      previewCanvas.dataset.frameSrc = frameSrc;
      previewCanvas.dataset.frameIndex = frameIndex;
    }

    // When Confirm clicked -> build final composite at full resolution and store finalPhoto
    confirmBtn.addEventListener('click', async () => {
      const frameSrc = previewCanvas.dataset.frameSrc;
      const idx = Number(previewCanvas.dataset.frameIndex);
      if (!frameSrc || !idx) return alert('Select a frame first.');

      const frameImg = await loadImage(frameSrc);
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = frameImg.naturalWidth;
      finalCanvas.height = frameImg.naturalHeight;
      const fctx = finalCanvas.getContext('2d');

      const slots = FRAME_SLOTS[idx];
      for (let i=0;i<4;i++){
        const s = slots[i];
        if (!s) continue;
        try {
          const img = await loadImage(photos[i]);
          drawImageCover(fctx, img, s.x, s.y, s.w, s.h);
        } catch(e){
          fctx.fillStyle = '#000';
          fctx.fillRect(s.x, s.y, s.w, s.h);
        }
      }

      fctx.drawImage(frameImg, 0, 0, finalCanvas.width, finalCanvas.height);
      const finalDataURL = finalCanvas.toDataURL('image/png');

      // store final and frame selection
      try {
        sessionStorage.setItem('finalPhoto', finalDataURL);
        sessionStorage.setItem('selectedFrame', frameSrc);
      } catch(e){
        console.error('storage error', e);
        // fallback: do not fail silently - still navigate
      }
      window.location.href = 'print.html';
    });

    backBtn.addEventListener('click', () => window.location.href = 'snap.html');

    // Optional: auto-select frame 1 at load (comment out if you don't want)
    // onFrameClick(1);

  })();
  </script>
</body>
</html>
