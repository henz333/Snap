<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Select Frame â€” abcSnap</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --blue1:#1E3C72; --blue2:#2A5298; --yellow:#FFD93D; --accent:#2A5298; }
    body { margin:0; font-family:'Poppins',sans-serif; background:linear-gradient(135deg,var(--blue1),var(--blue2)); color:#fff; display:flex; flex-direction:column; align-items:center; min-height:100vh; padding:24px; box-sizing:border-box; }
    h1 { font-family:'Baloo 2',cursive; color:var(--yellow); margin:0 0 8px; font-size:2rem; }
    p.lead { margin:0 0 18px; color:rgba(255,255,255,0.9); }
    .layout { display:flex; gap:24px; width:100%; max-width:1400px; align-items:flex-start; justify-content:center; flex-wrap:wrap; }
    .frame-grid { width:480px; display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .frame { background:rgba(255,255,255,0.06); border-radius:12px; padding:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:transform .15s,box-shadow .15s; }
    .frame:hover { transform:translateY(-6px); box-shadow:0 10px 30px rgba(0,0,0,0.35); }
    .frame img { width:100%; height:auto; border-radius:8px; object-fit:contain; display:block; }
    #preview-container { width:540px; min-height:640px; background:rgba(255,255,255,0.06); border-radius:14px; padding:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(0,0,0,0.35); }
    #preview-title { color:rgba(255,255,255,0.9); margin-bottom:8px; font-weight:600; }
    #preview-canvas { background:#111; border-radius:8px; max-width:100%; height:auto; display:block; }
    .help { font-size:0.9rem; color:rgba(255,255,255,0.7); margin-top:10px; }
    .controls { margin-top:16px; display:flex; gap:12px; flex-wrap:wrap; }
    button.primary { background:var(--yellow); color:var(--accent); border:none; padding:12px 18px; border-radius:10px; font-weight:700; cursor:pointer; box-shadow:0 10px 20px rgba(0,0,0,0.2); }
    button.ghost { background:transparent; color:rgba(255,255,255,0.9); border:1px solid rgba(255,255,255,0.08); padding:10px 14px; border-radius:10px; cursor:pointer; }
    footer { margin-top:28px; color:rgba(255,255,255,0.7); font-size:0.9rem; }
    @media (max-width:1000px) { .layout { flex-direction:column; align-items:center; } .frame-grid { width:90%; grid-template-columns:repeat(3,1fr); } #preview-container { width:90%; } }
  </style>
</head>
<body>
  <h1>ðŸŽ¨ Choose Your Frame</h1>
  <p class="lead">Click a frame on the left â€” preview will show on the right. When it looks good, press <strong>Confirm Frame</strong>.</p>

  <div class="layout">
    <div class="frame-grid" id="frameGrid"></div>

    <div id="preview-container" aria-live="polite">
      <div id="preview-title">Preview</div>
      <canvas id="preview-canvas"></canvas>
      <div class="help">Preview updates immediately when you click a frame. Confirm to continue.</div>

      <div class="controls">
        <button id="confirmBtn" class="primary" disabled>Confirm Frame</button>
        <button id="backBtn" class="ghost">Back to Capture</button>
      </div>
    </div>
  </div>

  <footer>abcSnap Booth â€” Business Week 2025</footer>

  <script>
  (function(){
    const GRID = { x:55, y:515, w:798, h:461, gapX:837, gapY:489 };
    const STRIP = { x:43, y:418, w:621, h:375, gapY:427 };
    const GRID_INDICES = [1,2,3,4];
    const STRIP_INDICES = [5,6];
    const FRAME_COUNT = 6;

    const frameGrid = document.getElementById('frameGrid');
    const previewCanvas = document.getElementById('preview-canvas');
    const confirmBtn = document.getElementById('confirmBtn');
    const backBtn = document.getElementById('backBtn');

    const photos = JSON.parse(sessionStorage.getItem('photos') || '[]'); // âœ… Use same sessionStorage key

    if (!photos || photos.length < 4) {
      alert('No photos found â€” please take your 4 photos first.');
      window.location.href = 'snap.html';
      return;
    }

    for (let i=1; i<=FRAME_COUNT; i++){
      const div = document.createElement('div');
      div.className='frame';
      div.innerHTML=`<img src="frames/frame${i}.png" alt="Frame ${i}" data-index="${i}">`;
      div.addEventListener('click', ()=>onFrameClick(i));
      frameGrid.appendChild(div);
    }

    async function loadImage(src){
      return new Promise((res,rej)=>{
        const img = new Image();
        img.onload = ()=>res(img);
        img.onerror = e=>rej(e);
        img.src=src;
      });
    }

    async function onFrameClick(index){
      confirmBtn.disabled=false;
      const frameSrc=`frames/frame${index}.png`;
      const frameImg=await loadImage(frameSrc);
      const isGrid = GRID_INDICES.includes(index);

      previewCanvas.width=frameImg.naturalWidth;
      previewCanvas.height=frameImg.naturalHeight;
      const ctx=previewCanvas.getContext('2d');
      ctx.clearRect(0,0,previewCanvas.width,previewCanvas.height);

      if(isGrid){
        const coords=[
          {x:GRID.x, y:GRID.y},
          {x:GRID.x+GRID.gapX, y:GRID.y},
          {x:GRID.x, y:GRID.y+GRID.gapY},
          {x:GRID.x+GRID.gapX, y:GRID.y+GRID.gapY}
        ];
        for(let i=0;i<4;i++) await drawPhotoToFit(ctx,photos[i],coords[i].x,coords[i].y,GRID.w,GRID.h);
      } else {
        for(let i=0;i<4;i++){
          const posY=STRIP.y+i*STRIP.gapY;
          await drawPhotoToFit(ctx,photos[i],STRIP.x,posY,STRIP.w,STRIP.h);
        }
      }

      ctx.drawImage(frameImg,0,0,previewCanvas.width,previewCanvas.height);
      previewCanvas.dataset.frameSrc=frameSrc;
      previewCanvas.dataset.index=index;
    }

    async function drawPhotoToFit(ctx, photoSrc, x, y, w, h){
      const img=await loadImage(photoSrc);
      const scale=Math.min(w/img.naturalWidth,h/img.naturalHeight);
      const drawW=img.naturalWidth*scale;
      const drawH=img.naturalHeight*scale;
      const offsetX=x+(w-drawW)/2;
      const offsetY=y+(h-drawH)/2;
      ctx.drawImage(img,offsetX,offsetY,drawW,drawH);
    }

    confirmBtn.addEventListener('click', async ()=>{
      const frameSrc=previewCanvas.dataset.frameSrc;
      const index=Number(previewCanvas.dataset.index);
      if(!frameSrc) return alert('Select a frame first.');

      const frameImg=await loadImage(frameSrc);
      const finalCanvas=document.createElement('canvas');
      finalCanvas.width=previewCanvas.width;
      finalCanvas.height=previewCanvas.height;
      const fctx=finalCanvas.getContext('2d');

      const isGrid = GRID_INDICES.includes(index);
      if(isGrid){
        const coords=[
          {x:GRID.x, y:GRID.y},
          {x:GRID.x+GRID.gapX, y:GRID.y},
          {x:GRID.x, y:GRID.y+GRID.gapY},
          {x:GRID.x+GRID.gapX, y:GRID.y+GRID.gapY}
        ];
        for(let i=0;i<4;i++) await drawPhotoToFit(fctx,photos[i],coords[i].x,coords[i].y,GRID.w,GRID.h);
      } else {
        for(let i=0;i<4;i++){
          const posY=STRIP.y+i*STRIP.gapY;
          await drawPhotoToFit(fctx,photos[i],STRIP.x,posY,STRIP.w,STRIP.h);
        }
      }

      fctx.drawImage(frameImg,0,0,finalCanvas.width,finalCanvas.height);
      const finalDataURL=finalCanvas.toDataURL('image/png');
      sessionStorage.setItem('finalPhoto',finalDataURL);
      sessionStorage.setItem('selectedFrame',frameSrc);
      window.location.href='print.html';
    });

    backBtn.addEventListener('click',()=>window.location.href='snap.html');
  })();
  </script>
</body>
</html>
