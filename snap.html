<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Take Snap â€” abcSnap</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  /* your original styling, trimmed for clarity */
  body{margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#1E3C72,#2A5298);color:#fff;display:flex;flex-direction:column;align-items:center;min-height:100vh}
  header{font-family:'Baloo 2',cursive;color:#FFD93D;padding:1.2rem;width:100%;text-align:center;background:rgba(255,255,255,0.06)}
  main{display:flex;gap:2rem;padding:2rem;width:100%;max-width:1200px;box-sizing:border-box;align-items:flex-start}
  #video-container{position:relative;background:rgba(255,255,255,0.06);border-radius:16px;overflow:hidden;width:960px;height:540px;display:flex;align-items:center;justify-content:center}
  video{width:100%;height:100%;object-fit:cover;display:block}
  #timer{position:absolute;top:12px;right:12px;background:rgba(255,255,255,0.95);color:#2A5298;border-radius:8px;padding:6px 10px;font-weight:700;opacity:0;transition:opacity .18s}
  #thumbnails{display:flex;flex-direction:column;gap:12px}
  #thumbnails img{width:200px;height:120px;object-fit:cover;border-radius:12px;box-shadow:0 6px 12px rgba(0,0,0,.25)}
  #controls{display:flex;gap:12px;justify-content:center;padding:1rem;width:100%}
  button{background:#FFD93D;color:#2A5298;border:none;padding:12px 18px;border-radius:16px;font-weight:600}
  @media (max-width:980px){#video-container{width:420px;height:236px} #thumbnails img{width:120px;height:72px}}
</style>
</head>
<body>
<header>ðŸ“¸ abcSnap Booth â€” Business Week 2025</header>
<main>
  <div id="video-container">
    <video id="video" autoplay playsinline></video>
    <div id="timer">3</div>
  </div>

  <div id="thumbnails" aria-hidden="false"></div>
</main>

<div id="controls">
  <button id="startBtn">Start Taking Photos</button>
  <button id="retakeBtn" disabled>Retake Selected Photo</button>
  <button id="retakeAllBtn" disabled>Retake All</button>
  <button id="nextButton" disabled>Next âžœ</button>
</div>

<footer style="margin-top:24px;color:rgba(255,255,255,.7)">Empowering Smiles â€” Business Week 2025</footer>

<script>
/*
 Behavior:
  - Capture 4 landscape photos sized to 898x540 (compressed JPEG).
  - Store compressed images in sessionStorage under 'photos' as an array of dataURLs.
  - Use sessionStorage (not localStorage) to avoid cross-session quota problems.
  - checkNextButton enables Next only when 4 photos are present.
*/

const TARGET_W = 898;
const TARGET_H = 540;

const video = document.getElementById('video');
const startBtn = document.getElementById('startBtn');
const retakeBtn = document.getElementById('retakeBtn');
const retakeAllBtn = document.getElementById('retakeAllBtn');
const nextButton = document.getElementById('nextButton');
const thumbnails = document.getElementById('thumbnails');
const timerEl = document.getElementById('timer');

let stream = null;
let photos = []; // dataURLs
let selectedIndex = -1;

async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'user', // front camera
        width: { ideal: 1280 },
        height: { ideal: 720 },
        aspectRatio: 16/9
      },
      audio: false
    });
    video.srcObject = stream;
    // remove any CSS mirroring if present (we want preview sensible). If you prefer mirrored preview, add transform CSS.
    video.style.transform = ''; 
  } catch(e){
    alert('Unable to access camera â€” allow camera permission and reload.');
    console.error(e);
  }
}

function captureToDataURL(){
  // create canvas at the exact target size to reduce saved image size
  const canvas = document.createElement('canvas');
  canvas.width = TARGET_W;
  canvas.height = TARGET_H;
  const ctx = canvas.getContext('2d');

  // draw the current video frame scaled to cover the canvas (cover behavior)
  // We'll implement cover: scale to fill and center-crop.
  const vw = video.videoWidth || TARGET_W;
  const vh = video.videoHeight || TARGET_H;
  const scale = Math.max(TARGET_W / vw, TARGET_H / vh);
  const drawW = vw * scale;
  const drawH = vh * scale;
  const dx = (TARGET_W - drawW) / 2;
  const dy = (TARGET_H - drawH) / 2;
  ctx.drawImage(video, dx, dy, drawW, drawH);

  // Export compressed JPEG to save quota
  return canvas.toDataURL('image/jpeg', 0.8);
}

function addThumbnail(dataURL){
  const img = document.createElement('img');
  img.src = dataURL;
  img.alt = 'Shot';
  thumbnails.appendChild(img);
  img.addEventListener('click', () => {
    Array.from(thumbnails.children).forEach(i => i.classList.remove('selected'));
    img.classList.add('selected');
    selectedIndex = Array.from(thumbnails.children).indexOf(img);
    retakeBtn.disabled = false;
  });
}

async function countdown(seconds){
  timerEl.style.opacity = '1';
  for(let i=seconds;i>0;i--){
    timerEl.textContent = i;
    await new Promise(r => setTimeout(r,1000));
  }
  timerEl.style.opacity = '0';
}

async function startTakingPhotos(){
  startBtn.disabled = true;
  retakeBtn.disabled = true;
  retakeAllBtn.disabled = true;
  nextButton.disabled = true;
  photos = [];
  thumbnails.innerHTML = '';
  startBtn.textContent = 'Taking Photos...';

  for (let i=0;i<4;i++){
    await countdown(3); // shorter countdown for speed; change to 5 if you prefer
    const data = captureToDataURL();
    photos.push(data);
    addThumbnail(data);
  }

  // save to sessionStorage (small compressed images)
  try {
    sessionStorage.setItem('photos', JSON.stringify(photos));
  } catch (e) {
    console.warn('sessionStorage error:', e);
  }

  startBtn.textContent = 'Start Taking Photos';
  startBtn.disabled = false;
  retakeAllBtn.disabled = false;
  checkNextButton();
}

function checkNextButton(){
  nextButton.disabled = photos.length !== 4;
}

async function retakeSelectedPhoto(){
  if (selectedIndex === -1) { alert('Select a thumbnail to retake'); return; }
  retakeBtn.disabled = true;
  startBtn.disabled = true;
  await countdown(2);
  const newData = captureToDataURL();
  photos[selectedIndex] = newData;
  thumbnails.children[selectedIndex].src = newData;
  thumbnails.children[selectedIndex].classList.remove('selected');
  selectedIndex = -1;
  retakeBtn.disabled = true;
  startBtn.disabled = false;
  try { sessionStorage.setItem('photos', JSON.stringify(photos)); } catch(e) {}
  checkNextButton();
}

async function retakeAll(){
  photos = [];
  thumbnails.innerHTML = '';
  selectedIndex = -1;
  retakeBtn.disabled = true;
  nextButton.disabled = true;
  startBtn.disabled = true;
  await startTakingPhotos();
}

nextButton.addEventListener('click', () => {
  if (photos.length < 4) { alert('Please take 4 photos first'); return; }
  // ensure latest photos saved
  try { sessionStorage.setItem('photos', JSON.stringify(photos)); } catch(e) {}
  // navigate to frames preview
  window.location.href = 'frames.html';
});

startBtn.addEventListener('click', startTakingPhotos);
retakeBtn.addEventListener('click', retakeSelectedPhoto);
retakeAllBtn.addEventListener('click', retakeAll);

startCamera();
</script>
</body>
</html>
