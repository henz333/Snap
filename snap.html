<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>abcSnap - Snap Photos</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet" />
  <style>
    body { margin:0; font-family:'Baloo 2', cursive; background:#fff; color:#3D5AF1; display:flex; flex-direction:column; min-height:100vh; }
    header { text-align:center; padding:1rem; background:#FFD93D; color:#3D5AF1; font-size:1.8rem; font-weight:700; box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    main { flex:1; display:flex; flex-direction:row; gap:1.5rem; padding:1.5rem; width:100%; max-width:1100px; margin:0 auto; justify-content:flex-start; align-items:flex-start; flex-wrap:wrap;}
    #video-container { background:white; position:relative; border-radius:36px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.15); flex-shrink:0; }
    video { width:100%; height:100%; object-fit:cover; border-radius:30px; }
    #timer { position:absolute; top:16px; right:16px; background:rgba(255,255,255,0.85); color:#3D5AF1; font-weight:700; font-size:2rem; padding:0.3rem 0.8rem; border-radius:16px; user-select:none; pointer-events:none; opacity:0; transition:opacity 0.4s ease; }
    #thumbnails { width:200px; height:480px; overflow-y:scroll; scrollbar-width:thin; scrollbar-color:#FFD93D transparent; display:flex; flex-direction:column; gap:1rem; padding-right:0.5rem; flex-shrink:0; }
    #thumbnails::-webkit-scrollbar { width:6px; }
    #thumbnails::-webkit-scrollbar-thumb { background-color:#FFD93D; border-radius:10px; }
    #thumbnails img { width:100%; height:120px; border-radius:20px; box-shadow:0 4px 12px rgba(0,0,0,0.15); object-fit:cover; cursor:pointer; border:3px solid transparent; opacity:0; transform:translateY(20px); animation:fadeInSlide 0.4s forwards; transition:border-color 0.2s ease, transform 0.2s ease; flex:0 0 auto; }
    #thumbnails img:hover { transform:scale(1.02); }
    #thumbnails img.selected { border-color:#FFD93D; }
    #controls { margin:1rem auto 2rem; text-align:center; }
    button { background-color:#FFD93D; border:none; color:#3D5AF1; padding:1rem 3rem; font-size:1.2rem; border-radius:24px; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,0.2); transition: transform 0.2s ease, box-shadow 0.2s ease; font-family:'Baloo 2', cursive; font-weight:700; }
    button:hover:not(:disabled){transform:scale(1.05);box-shadow:0 8px 20px rgba(0,0,0,0.3);}
    button:disabled{background-color:#ddd; cursor:not-allowed; color:#999; box-shadow:none;}
    @keyframes fadeInSlide { to{ opacity:1; transform:translateY(0); } }
    @media (max-width:768px){ main{ flex-direction:column; align-items:center; } #video-container{ width:100%; max-width:90vw; height:auto; aspect-ratio:4/3; } #thumbnails{ flex-direction:row; width:100%; max-height:none; overflow-x:auto; overflow-y:hidden; justify-content:center; margin-top:1rem; height:auto;} #thumbnails img{ width:120px; height:auto; } }
  </style>
</head>
<body>
  <header>abcSnap - Snap Your 4 Photos</header>

  <main>
    <div id="video-container">
      <video id="video" autoplay playsinline></video>
      <div id="timer">3</div>
    </div>
    <div id="thumbnails" aria-label="Photos taken"></div>
  </main>

  <div id="controls">
    <button id="startBtn">Start Taking Photos</button>
    <button id="retakeBtn" disabled>Delete & Retake Selected Photo</button>
  </div>

  <script>
    // ===== GET LAYOUT CHOICE =====
    const layout = localStorage.getItem('photoLayout') || 'portrait';
    const videoContainer = document.getElementById('video-container');

    if(layout === 'landscape'){
      videoContainer.style.width = '720px';
      videoContainer.style.height = '480px';
    } else {
      videoContainer.style.width = '480px';
      videoContainer.style.height = '640px';
    }

    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const thumbnails = document.getElementById('thumbnails');
    const timerEl = document.getElementById('timer');
    const retakeBtn = document.getElementById('retakeBtn');

    let photos = [];
    let stream;
    let selectedIndex = -1;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            aspectRatio: layout === 'landscape' ? 16/9 : 3/4,
            facingMode: "environment"
          },
          audio: false
        });
        video.srcObject = stream;
      } catch(err) {
        alert("Unable to access camera.");
        console.error(err);
      }
    }

    function takePhoto() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/png');
    }

    function addThumbnail(imgSrc) {
      const img = document.createElement('img');
      img.src = imgSrc;
      thumbnails.appendChild(img);
      img.classList.add('selected');
      setTimeout(()=> img.classList.remove('selected'), 1500);
    }

    async function countdown(seconds){
      timerEl.style.opacity='1';
      for(let i=seconds;i>0;i--){
        timerEl.textContent=i;
        await new Promise(r=>setTimeout(r,1000));
      }
      timerEl.style.opacity='0';
    }

    async function startTakingPhotos(){
      startBtn.disabled=true;
      photos=[];
      thumbnails.innerHTML='';
      startBtn.textContent="Taking Photos...";

      for(let i=0;i<4;i++){
        await countdown(5);
        const photo=takePhoto();
        photos.push(photo);
        addThumbnail(photo);
      }

      timerEl.textContent='';
      startBtn.disabled=false;
      startBtn.textContent="Retake Photos";
    }

    startBtn.addEventListener('click', startTakingPhotos);
    thumbnails.addEventListener('click', (e)=>{
      if(e.target.tagName==='IMG'){
        [...thumbnails.children].forEach((img,idx)=> img.classList.remove('selected'));
        selectedIndex=[...thumbnails.children].indexOf(e.target);
        e.target.classList.add('selected');
        retakeBtn.disabled=selectedIndex===-1;
      }
    });

    retakeBtn.addEventListener('click', async ()=>{
      if(selectedIndex===-1) return;
      retakeBtn.disabled=true;
      startBtn.disabled=true;
      await countdown(5);
      const newPhoto=takePhoto();
      photos[selectedIndex]=newPhoto;
      thumbnails.children[selectedIndex].src=newPhoto;
      thumbnails.children[selectedIndex].classList.remove('selected');
      selectedIndex=-1;
      retakeBtn.disabled=true;
      startBtn.disabled=false;
    });

    startCamera();
  </script>
</body>
</html>
